# UE4 地圖導入系統說明

本目錄負責處理從 Unreal Engine 4 導出的地圖數據，並將其轉換為遊戲服務器可用的格式。

## 🗺️ 功能概述

UE4 導入系統允許使用 Unreal Engine 4 作為地圖編輯器，設計師可以在視覺化環境中：
- 放置防禦塔、基地、中立生物
- 設計小兵路徑和導航網格
- 設定重生點和戰略要地
- 調整地形和障礙物

## 📁 檔案結構

### reader.rs

負責讀取和解析 UE4 導出的 JSON 地圖檔案。

#### 主要功能

1. **JSON 解析**: 讀取 UE4 導出的地圖數據
2. **座標轉換**: 將 UE4 座標系轉換為遊戲座標系
3. **數據驗證**: 確保地圖數據的完整性和正確性
4. **實體生成**: 根據地圖數據創建遊戲實體

#### 地圖數據結構

```json
{
  "version": "1.0",
  "map_name": "summoner_rift",
  "map_size": {
    "width": 10000,
    "height": 10000
  },
  "spawn_points": {
    "team_1": {"x": 1000, "y": 1000},
    "team_2": {"x": 9000, "y": 9000}
  },
  "towers": [
    {
      "id": "tower_1",
      "team": 1,
      "position": {"x": 2000, "y": 2000},
      "type": "outer",
      "level": 1
    }
  ],
  "creep_paths": [
    {
      "lane": "top",
      "waypoints": [
        {"x": 1000, "y": 1000},
        {"x": 1500, "y": 1500}
      ]
    }
  ],
  "neutral_camps": [
    {
      "id": "dragon",
      "position": {"x": 5000, "y": 3000},
      "spawn_time": 120,
      "respawn_time": 360
    }
  ]
}
```

## 🔄 座標系統轉換

### UE4 座標系
- **原點**: 地圖中心
- **單位**: 厘米（cm）
- **方向**: X=東, Y=北, Z=上

### 遊戲座標系
- **原點**: 地圖左下角
- **單位**: 遊戲單位（1單位 = 1像素）
- **方向**: X=右, Y=上

### 轉換公式
```rust
game_x = (ue4_x / 100.0) + map_width / 2.0
game_y = (ue4_y / 100.0) + map_height / 2.0
```

## 🛠️ 使用流程

### 1. UE4 地圖設計

在 Unreal Engine 4 中：
1. 使用專用的地圖編輯器插件
2. 放置遊戲物件（塔、基地、路徑點等）
3. 設定物件屬性（隊伍、等級、類型等）
4. 導出為 JSON 格式

### 2. 地圖導入

```rust
use crate::ue4::reader::UE4MapReader;

// 讀取地圖檔案
let map_data = UE4MapReader::load("map.json")?;

// 創建遊戲實體
for tower_data in map_data.towers {
    let tower_entity = world.create_entity()
        .with(Pos(tower_data.position))
        .with(Tower {
            team: tower_data.team,
            level: tower_data.level,
            tower_type: tower_data.tower_type,
        })
        .build();
}
```

### 3. 運行時使用

地圖數據在遊戲啟動時載入，並用於：
- 初始化遊戲實體
- 設定小兵路徑
- 配置重生點
- 建立導航網格

## 📐 地圖元素說明

### 防禦塔（Towers）
- **類型**: outer（外塔）、inner（內塔）、inhibitor（高地塔）、nexus（基地塔）
- **屬性**: 位置、隊伍、等級、血量、攻擊力

### 小兵路徑（Creep Paths）
- **路線**: top（上路）、mid（中路）、bot（下路）
- **路徑點**: 有序的座標列表，小兵依序行進

### 中立生物營地（Neutral Camps）
- **類型**: 小野怪、大野怪、史詩野怪（龍、男爵）
- **時間**: 初始生成時間、重生間隔

### 其他元素
- **基地**: 雙方主基地位置
- **商店**: 物品購買點
- **視野元素**: 草叢、高地等

## 🎯 最佳實踐

1. **地圖驗證**: 導入時檢查地圖完整性
   - 確保雙方基地都存在
   - 驗證小兵路徑連通性
   - 檢查防禦塔數量平衡

2. **性能優化**: 
   - 預處理路徑數據
   - 建立空間索引
   - 快取靜態地圖信息

3. **版本管理**:
   - 地圖檔案包含版本號
   - 支援不同版本的兼容處理
   - 記錄地圖更新歷史

## 🔧 擴展功能

### 計劃中的功能
- 動態地圖元素（可破壞地形）
- 天氣和時間系統
- 地圖事件觸發器
- 自定義地圖腳本

### 地圖編輯器集成
- 實時預覽
- 平衡性分析工具
- 自動路徑生成
- 對稱性檢查

## ⚠️ 注意事項

1. **檔案大小**: 大型地圖可能產生較大的 JSON 檔案
2. **精度問題**: 座標轉換時注意浮點數精度
3. **向後兼容**: 更新地圖格式時保持兼容性
4. **安全檢查**: 驗證地圖數據，防止惡意數據